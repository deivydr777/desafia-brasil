<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <script src="js/config.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - Desafia Brasil</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- CSS Principal -->
    <link rel="stylesheet" href="css/style.css">
    
    <style>
        /* ✅ ESTILOS APRIMORADOS PARA VALIDAÇÃO INTELIGENTE */
        .form-control.is-valid {
            border-color: #28a745;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='m2.3 6.73.8.8 3.8-3.8-.8-.8-3 3-1.4-1.4-.8.8z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }

        .form-control.is-invalid {
            border-color: #dc3545;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23dc3545' viewBox='0 0 12 12'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 4.6l1.4 1.4-1.4 1.4'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }

        .password-strength {
            transition: all 0.3s ease;
        }

        .progress-bar.bg-danger {
            background-color: #dc3545 !important;
        }

        .progress-bar.bg-warning {
            background-color: #ffc107 !important;
        }

        .progress-bar.bg-info {
            background-color: #0dcaf0 !important;
        }

        .progress-bar.bg-success {
            background-color: #28a745 !important;
        }

        .form-step {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .auth-icon {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .input-group .btn {
            border-color: var(--bs-border-color);
        }

        .invalid-feedback, .valid-feedback {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navbar Simples -->
    <nav class="navbar navbar-light bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="index.html">
                <i class="fas fa-graduation-cap me-2"></i>Desafia Brasil
            </a>
            <div>
                <a href="index.html" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Voltar
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mt-4 mb-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <!-- Cadastro Card -->
                <div class="card shadow border-0 rounded-3">
                    <div class="card-body p-5">
                        <div class="text-center mb-4">
                            <div class="auth-icon bg-success text-white rounded-circle mx-auto mb-3">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <h2 class="fw-bold">Criar Conta</h2>
                            <p class="text-muted">Junte-se a milhares de estudantes</p>
                        </div>

                        <!-- Progress Indicator -->
                        <div class="progress mb-4" style="height: 4px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="progressBar"></div>
                        </div>

                        <!-- Alerts -->
                        <div id="alertContainer"></div>

                        <!-- Cadastro Form -->
                        <form id="registerForm" novalidate>
                            <!-- Etapa 1: Dados Básicos -->
                            <div class="form-step" id="step1">
                                <h5 class="fw-bold mb-3">
                                    <span class="badge bg-primary me-2">1</span>
                                    Dados Básicos
                                </h5>

                                <div class="mb-3">
                                    <label for="fullName" class="form-label">Nome Completo</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-user"></i>
                                        </span>
                                        <input type="text" class="form-control" id="fullName" 
                                               placeholder="Seu nome completo" required>
                                        <div class="invalid-feedback">
                                            Por favor, insira seu nome completo.
                                        </div>
                                        <div class="valid-feedback">
                                            Ótimo! Nome válido.
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="email" class="form-label">E-mail</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-envelope"></i>
                                        </span>
                                        <input type="email" class="form-control" id="email" 
                                               placeholder="seu@email.com" required>
                                        <div class="invalid-feedback">
                                            Por favor, insira um e-mail válido.
                                        </div>
                                        <div class="valid-feedback">
                                            E-mail válido!
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="password" class="form-label">Senha</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-lock"></i>
                                        </span>
                                        <input type="password" class="form-control" id="password" 
                                               placeholder="Mínimo 6 caracteres" required minlength="6">
                                        <button type="button" class="btn btn-outline-secondary" id="togglePassword">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <div class="invalid-feedback">
                                            A senha deve ter pelo menos 6 caracteres.
                                        </div>
                                        <div class="valid-feedback">
                                            Senha forte!
                                        </div>
                                    </div>
                                    <!-- Password Strength Indicator -->
                                    <div class="password-strength mt-2">
                                        <div class="progress" style="height: 4px;">
                                            <div class="progress-bar" id="passwordStrength" style="width: 0%"></div>
                                        </div>
                                        <small class="text-muted" id="strengthText">Digite uma senha</small>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label for="confirmPassword" class="form-label">Confirmar Senha</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-lock"></i>
                                        </span>
                                        <input type="password" class="form-control" id="confirmPassword" 
                                               placeholder="Digite a senha novamente" required>
                                        <div class="invalid-feedback">
                                            As senhas não coincidem.
                                        </div>
                                        <div class="valid-feedback">
                                            Senhas coincidem!
                                        </div>
                                    </div>
                                </div>

                                <button type="button" class="btn btn-primary w-100" id="nextStep1">
                                    Próximo <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                            <!-- Etapa 2: Informações Acadêmicas -->
                            <div class="form-step d-none" id="step2">
                                <h5 class="fw-bold mb-3">
                                    <span class="badge bg-primary me-2">2</span>
                                    Informações Acadêmicas
                                </h5>

                                <div class="mb-3">
                                    <label for="schoolYear" class="form-label">Ano Escolar</label>
                                    <select class="form-select" id="schoolYear" required>
                                        <option value="">Selecione seu ano</option>
                                        <option value="1ano">1º Ano do Ensino Médio</option>
                                        <option value="2ano">2º Ano do Ensino Médio</option>
                                        <option value="3ano">3º Ano do Ensino Médio</option>
                                        <option value="cursinho">Cursinho</option>
                                        <option value="formado">Já me formei</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Por favor, selecione seu ano escolar.
                                    </div>
                                    <div class="valid-feedback">
                                        Perfeito!
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="school" class="form-label">Escola (Opcional)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-school"></i>
                                        </span>
                                        <input type="text" class="form-control" id="school" 
                                               placeholder="Nome da sua escola">
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="targetExam" class="form-label">Principal Vestibular</label>
                                    <select class="form-select" id="targetExam" required>
                                        <option value="">Qual vestibular você pretende fazer?</option>
                                        <option value="enem">ENEM</option>
                                        <option value="fuvest">FUVEST (USP)</option>
                                        <option value="unicamp">UNICAMP</option>
                                        <option value="unesp">UNESP</option>
                                        <option value="uerj">UERJ</option>
                                        <option value="puc">PUC</option>
                                        <option value="outros">Outros</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Por favor, selecione seu vestibular alvo.
                                    </div>
                                    <div class="valid-feedback">
                                        Excelente escolha!
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-6">
                                        <button type="button" class="btn btn-outline-secondary w-100" id="backStep1">
                                            <i class="fas fa-arrow-left me-2"></i>Voltar
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button type="button" class="btn btn-primary w-100" id="nextStep2">
                                            Próximo <i class="fas fa-arrow-right ms-2"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- Etapa 3: Localização -->
                            <div class="form-step d-none" id="step3">
                                <h5 class="fw-bold mb-3">
                                    <span class="badge bg-primary me-2">3</span>
                                    Localização
                                </h5>

                                <div class="mb-3">
                                    <label for="state" class="form-label">Estado</label>
                                    <select class="form-select" id="state" required>
                                        <option value="">Selecione seu estado</option>
                                        <option value="AC">Acre</option>
                                        <option value="AL">Alagoas</option>
                                        <option value="AP">Amapá</option>
                                        <option value="AM">Amazonas</option>
                                        <option value="BA">Bahia</option>
                                        <option value="CE">Ceará</option>
                                        <option value="DF">Distrito Federal</option>
                                        <option value="ES">Espírito Santo</option>
                                        <option value="GO">Goiás</option>
                                        <option value="MA">Maranhão</option>
                                        <option value="MT">Mato Grosso</option>
                                        <option value="MS">Mato Grosso do Sul</option>
                                        <option value="MG">Minas Gerais</option>
                                        <option value="PA">Pará</option>
                                        <option value="PB">Paraíba</option>
                                        <option value="PR">Paraná</option>
                                        <option value="PE">Pernambuco</option>
                                        <option value="PI">Piauí</option>
                                        <option value="RJ">Rio de Janeiro</option>
                                        <option value="RN">Rio Grande do Norte</option>
                                        <option value="RS">Rio Grande do Sul</option>
                                        <option value="RO">Rondônia</option>
                                        <option value="RR">Roraima</option>
                                        <option value="SC">Santa Catarina</option>
                                        <option value="SP">São Paulo</option>
                                        <option value="SE">Sergipe</option>
                                        <option value="TO">Tocantins</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Por favor, selecione seu estado.
                                    </div>
                                    <div class="valid-feedback">
                                        Estado selecionado!
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label for="city" class="form-label">Cidade</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-map-marker-alt"></i>
                                        </span>
                                        <input type="text" class="form-control" id="city" 
                                               placeholder="Digite sua cidade" required>
                                        <div class="invalid-feedback">
                                            Por favor, digite sua cidade.
                                        </div>
                                        <div class="valid-feedback">
                                            Cidade válida!
                                        </div>
                                    </div>
                                </div>

                                <!-- Terms and Privacy -->
                                <div class="mb-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                                        <label class="form-check-label small" for="agreeTerms">
                                            Concordo com os 
                                            <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Termos de Uso</a> 
                                            e 
                                            <a href="#" data-bs-toggle="modal" data-bs-target="#privacyModal">Política de Privacidade</a>
                                        </label>
                                        <div class="invalid-feedback">
                                            Você deve concordar com os termos para continuar.
                                        </div>
                                    </div>

                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="agreeEmails">
                                        <label class="form-check-label small" for="agreeEmails">
                                            Quero receber dicas de estudo e novidades por e-mail
                                        </label>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-6">
                                        <button type="button" class="btn btn-outline-secondary w-100" id="backStep2">
                                            <i class="fas fa-arrow-left me-2"></i>Voltar
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button type="submit" class="btn btn-success w-100" id="registerBtn">
                                            <span class="spinner-border spinner-border-sm d-none me-2" id="registerSpinner"></span>
                                            <i class="fas fa-check me-2"></i>Criar Conta
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                        <!-- Login Link -->
                        <div class="text-center mt-4 pt-3 border-top">
                            <p class="text-muted mb-2">Já tem uma conta?</p>
                            <a href="login.html" class="btn btn-outline-primary">
                                <i class="fas fa-sign-in-alt me-2"></i>
                                Fazer login
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Termos de Uso -->
    <div class="modal fade" id="termsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Termos de Uso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>1. Aceitação dos Termos</h6>
                    <p>Ao utilizar o Desafia Brasil, você concorda com estes termos de uso.</p>
                    
                    <h6>2. Uso da Plataforma</h6>
                    <p>A plataforma é gratuita para uso educacional. É proibido o uso comercial sem autorização.</p>
                    
                    <h6>3. Responsabilidades do Usuário</h6>
                    <p>Você é responsável pela veracidade das informações fornecidas e pelo uso adequado da plataforma.</p>
                    
                    <h6>4. Propriedade Intelectual</h6>
                    <p>Todo o conteúdo da plataforma é protegido por direitos autorais.</p>
                    
                    <h6>5. Modificações</h6>
                    <p>Reservamos o direito de modificar estes termos a qualquer momento.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Política de Privacidade -->
    <div class="modal fade" id="privacyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Política de Privacidade</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6>1. Coleta de Dados</h6>
                    <p>Coletamos apenas os dados necessários para oferecer nossos serviços educacionais.</p>
                    
                    <h6>2. Uso dos Dados</h6>
                    <p>Seus dados são utilizados para personalizar sua experiência de aprendizado e gerar estatísticas anônimas.</p>
                    
                    <h6>3. Compartilhamento</h6>
                    <p>Não compartilhamos seus dados pessoais com terceiros sem seu consentimento.</p>
                    
                    <h6>4. Segurança</h6>
                    <p>Implementamos medidas de segurança robustas para proteger seus dados.</p>
                    
                    <h6>5. Seus Direitos</h6>
                    <p>Você pode solicitar acesso, correção ou exclusão de seus dados a qualquer momento.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- ✅ JAVASCRIPT COMPLETO E FUNCIONAL -->
    <script>
        // ✅ SISTEMA DE VALIDAÇÃO CORRIGIDO - DESAFIA BRASIL
        document.addEventListener('DOMContentLoaded', function() {
            
            // ✅ ESCONDER TODAS AS MENSAGENS VERMELHAS NO INÍCIO
            function hideAllValidationMessages() {
                const errorElements = document.querySelectorAll('.invalid-feedback');
                const inputElements = document.querySelectorAll('.form-control, .form-select, .form-check-input');
                
                errorElements.forEach(element => {
                    element.style.display = 'none';
                });
                
                inputElements.forEach(element => {
                    element.classList.remove('is-invalid', 'is-valid');
                });
            }

            // Executar na inicialização
            hideAllValidationMessages();

            // ✅ CONTROLE DE STEPS
            let currentStep = 1;
            const totalSteps = 3;
            const fieldsInteracted = new Set(); // Controla campos que usuário já mexeu

            // ✅ ATUALIZAR BARRA DE PROGRESSO
            function updateProgressBar() {
                const progressBar = document.getElementById('progressBar');
                const progress = (currentStep / totalSteps) * 100;
                progressBar.style.width = progress + '%';
            }

            // ✅ MOSTRAR/ESCONDER STEPS
            function showStep(stepNumber) {
                // Esconder todos os steps
                document.querySelectorAll('.form-step').forEach(step => {
                    step.classList.add('d-none');
                });
                
                // Mostrar step atual
                document.getElementById('step' + stepNumber).classList.remove('d-none');
                
                currentStep = stepNumber;
                updateProgressBar();
            }
            // ✅ VALIDAÇÃO INTELIGENTE - SÓ VALIDA QUANDO NECESSÁRIO
            function validateField(fieldId, showError = false) {
                const field = document.getElementById(fieldId);
                if (!field) return true;

                const value = field.value.trim();
                let isValid = true;
                let errorMessage = '';

                // Verificações específicas por campo
                switch (fieldId) {
                    case 'fullName':
                        if (!value || value.length < 2) {
                            isValid = false;
                            errorMessage = 'Nome deve ter pelo menos 2 caracteres';
                        }
                        break;

                    case 'email':
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!value || !emailRegex.test(value)) {
                            isValid = false;
                            errorMessage = 'Digite um email válido';
                        }
                        break;

                    case 'password':
                        if (!value || value.length < 6) {
                            isValid = false;
                            errorMessage = 'Senha deve ter pelo menos 6 caracteres';
                        }
                        break;

                    case 'confirmPassword':
                        const password = document.getElementById('password').value;
                        if (!value || value !== password) {
                            isValid = false;
                            errorMessage = 'As senhas não coincidem';
                        }
                        break;

                    case 'schoolYear':
                    case 'targetExam':
                    case 'state':
                        if (!value) {
                            isValid = false;
                            errorMessage = 'Este campo é obrigatório';
                        }
                        break;

                    case 'city':
                        if (!value || value.length < 2) {
                            isValid = false;
                            errorMessage = 'Digite o nome da cidade';
                        }
                        break;

                    case 'agreeTerms':
                        if (!field.checked) {
                            isValid = false;
                            errorMessage = 'Você deve aceitar os termos';
                        }
                        break;
                }

                // Aplicar feedback visual apenas se necessário
                if (showError && fieldsInteracted.has(fieldId)) {
                    const feedback = field.closest('.mb-3, .mb-4').querySelector('.invalid-feedback');
                    
                    if (isValid) {
                        field.classList.remove('is-invalid');
                        field.classList.add('is-valid');
                        if (feedback) feedback.style.display = 'none';
                    } else {
                        field.classList.remove('is-valid');
                        field.classList.add('is-invalid');
                        if (feedback) {
                            feedback.textContent = errorMessage;
                            feedback.style.display = 'block';
                        }
                    }
                }

                return isValid;
            }

            // ✅ VALIDAR STEP COMPLETO
            function validateStep(stepNumber) {
                const stepFields = {
                    1: ['fullName', 'email', 'password', 'confirmPassword'],
                    2: ['schoolYear', 'targetExam'],
                    3: ['state', 'city', 'agreeTerms']
                };

                const fields = stepFields[stepNumber] || [];
                let allValid = true;

                fields.forEach(fieldId => {
                    fieldsInteracted.add(fieldId); // Marcar como interagido
                    if (!validateField(fieldId, true)) {
                        allValid = false;
                    }
                });

                return allValid;
            }
            // ✅ INDICADOR DE FORÇA DA SENHA (CORRIGIDO)
            function updatePasswordStrength(password) {
                const strengthBar = document.getElementById('passwordStrength');
                const strengthText = document.getElementById('strengthText');
                
                if (!strengthBar || !strengthText) return;

                let strength = 0;
                let label = '';
                let colorClass = '';

                if (password.length === 0) {
                    label = 'Digite uma senha';
                    colorClass = '';
                } else if (password.length < 6) {
                    strength = 25;
                    label = 'Muito fraca';
                    colorClass = 'bg-danger';
                } else {
                    strength = 50; // Base para 6+ caracteres
                    
                    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 15;
                    if (/\d/.test(password)) strength += 15;
                    if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength += 20;

                    if (strength <= 50) {
                        label = 'Fraca';
                        colorClass = 'bg-warning';
                    } else if (strength <= 80) {
                        label = 'Boa';
                        colorClass = 'bg-info';
                    } else {
                        label = 'Forte';
                        colorClass = 'bg-success';
                    }
                }

                strengthBar.style.width = strength + '%';
                strengthBar.className = 'progress-bar ' + colorClass;
                strengthText.textContent = label;
            }

            // ✅ TOGGLE MOSTRAR/ESCONDER SENHA (CORRIGIDO)
            const togglePassword = document.getElementById('togglePassword');
            if (togglePassword) {
                togglePassword.addEventListener('click', function() {
                    const passwordField = document.getElementById('password');
                    const icon = this.querySelector('i');
                    
                    if (passwordField.type === 'password') {
                        passwordField.type = 'text';
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                    } else {
                        passwordField.type = 'password';
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                    }
                });
            }
            // ✅ EVENTOS DOS CAMPOS
            
            // Força da senha em tempo real
            const passwordField = document.getElementById('password');
            if (passwordField) {
                passwordField.addEventListener('input', function() {
                    updatePasswordStrength(this.value);
                    if (fieldsInteracted.has('password')) {
                        validateField('password', true);
                    }
                });

                passwordField.addEventListener('blur', function() {
                    fieldsInteracted.add('password');
                    validateField('password', true);
                });
            }

            // Confirmar senha
            const confirmPasswordField = document.getElementById('confirmPassword');
            if (confirmPasswordField) {
                confirmPasswordField.addEventListener('blur', function() {
                    fieldsInteracted.add('confirmPassword');
                    validateField('confirmPassword', true);
                });

                confirmPasswordField.addEventListener('input', function() {
                    if (fieldsInteracted.has('confirmPassword')) {
                        validateField('confirmPassword', true);
                    }
                });
            }

            // Outros campos - validar apenas após blur
            ['fullName', 'email', 'schoolYear', 'targetExam', 'state', 'city'].forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('blur', function() {
                        fieldsInteracted.add(fieldId);
                        validateField(fieldId, true);
                    });

                    field.addEventListener('input', function() {
                        if (fieldsInteracted.has(fieldId)) {
                            validateField(fieldId, true);
                        }
                    });
                }
            });

            // Checkbox dos termos
            const agreeTermsField = document.getElementById('agreeTerms');
            if (agreeTermsField) {
                agreeTermsField.addEventListener('change', function() {
                    fieldsInteracted.add('agreeTerms');
                    validateField('agreeTerms', true);
                });
            }
            // ✅ NAVEGAÇÃO ENTRE STEPS (CORRIGIDA)
            
            // Próximo Step 1
            const nextStep1 = document.getElementById('nextStep1');
            if (nextStep1) {
                nextStep1.addEventListener('click', function() {
                    if (validateStep(1)) {
                        showStep(2);
                    }
                });
            }

            // Próximo Step 2
            const nextStep2 = document.getElementById('nextStep2');
            if (nextStep2) {
                nextStep2.addEventListener('click', function() {
                    if (validateStep(2)) {
                        showStep(3);
                    }
                });
            }

            // Voltar Step 1
            const backStep1 = document.getElementById('backStep1');
            if (backStep1) {
                backStep1.addEventListener('click', function() {
                    showStep(1);
                });
            }

            // Voltar Step 2
            const backStep2 = document.getElementById('backStep2');
            if (backStep2) {
                backStep2.addEventListener('click', function() {
                    showStep(2);
                });
            }
            // ✅ SUBMIT FINAL
            const registerForm = document.getElementById('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    if (!validateStep(3)) {
                        return;
                    }

                    const submitBtn = document.getElementById('registerBtn');
                    const spinner = document.getElementById('registerSpinner');
                    
                    // Mostrar loading
                    submitBtn.disabled = true;
                    spinner.classList.remove('d-none');
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Criando conta...';

                    // Coletar dados
                    const formData = {
                        nome: document.getElementById('fullName').value.trim(),
                        email: document.getElementById('email').value.trim(),
                        senha: document.getElementById('password').value,
                        confirmarSenha: document.getElementById('confirmPassword').value,
                        serie: document.getElementById('schoolYear').value,
                        escola: document.getElementById('school').value.trim(),
                        vestibular: document.getElementById('targetExam').value,
                        estado: document.getElementById('state').value,
                        cidade: document.getElementById('city').value.trim(),
                        aceitaTermos: document.getElementById('agreeTerms').checked,
                        aceitaEmails: document.getElementById('agreeEmails').checked
                    };

                    try {
                        // ✅ ENVIAR PARA API DO RENDER
                        const response = await fetch('https://desafia-brasil.onrender.com/api/auth/register', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formData)
                        });

                        const result = await response.json();

                        if (result.success) {
                            // Mostrar sucesso
                            document.getElementById('alertContainer').innerHTML = `
                                <div class="alert alert-success alert-dismissible fade show" role="alert">
                                    🎉 Conta criada com sucesso! Redirecionando para o dashboard...
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            `;
                            
                            // Salvar dados se necessário
                            if (result.authentication && result.authentication.accessToken) {
                                localStorage.setItem('authToken', result.authentication.accessToken);
                                localStorage.setItem('user', JSON.stringify(result.user));
                            }

                            // Redirecionar
                            setTimeout(() => {
                                window.location.href = 'dashboard.html';
                            }, 2000);
                        } else {
                            // Mostrar erro
                            document.getElementById('alertContainer').innerHTML = `
                                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                    ${result.message || 'Erro ao criar conta. Tente novamente.'}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            `;
                        }

                    } catch (error) {
                        console.error('Erro na requisição:', error);
                        document.getElementById('alertContainer').innerHTML = `
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                Erro de conexão. Verifique sua internet e tente novamente.
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        `;
                    } finally {
                        // Restaurar botão
                        submitBtn.disabled = false;
                        spinner.classList.add('d-none');
                        submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Criar Conta';
                    }
                });
            }

            // Inicializar
            updateProgressBar();
            setTimeout(() => {
                const firstField = document.getElementById('fullName');
                if (firstField) firstField.focus();
            }, 500);
        });
    </script>
</body>
</html>
